<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>マスク映像 + カメラ映像</title>
  <style>
    body {
      margin: 0;
      background: black;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      overflow: hidden;
    }
    #startButton {
      position: absolute;
      z-index: 10;
      padding: 1em 2em;
      font-size: 1.2em;
    }
    canvas {
      width: 100%;
      height: 100%;
      object-fit: cover;
      /* 垂直方向に反転 */
      transform: scale(1, -1);
    }
  </style>
</head>
<body>
  <button id="startButton">▶ スタート</button>
  <canvas id="canvas"></canvas>

  <!-- あらかじめ用意した動画 -->
  <video id="bgVideo" src="your-video.mp4" playsinline muted loop></video>
  <video id="maskVideo" src="your-mask.mp4" playsinline muted loop></video>
  <video id="camVideo" playsinline muted></video>

  <script>
    const startButton = document.getElementById("startButton");
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    const bgVideo = document.getElementById("bgVideo");
    const maskVideo = document.getElementById("maskVideo");
    const camVideo = document.getElementById("camVideo");

    async function init() {
      // カメラ映像を取得
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
        camVideo.srcObject = stream;
        await camVideo.play();
      } catch (err) {
        alert("カメラにアクセスできません: " + err);
        return;
      }

      // 背景とマスク動画の再生
      await bgVideo.play();
      await maskVideo.play();

      // canvas サイズ設定
      function resize() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
      }
      resize();
      window.addEventListener("resize", resize);

      // 描画ループ
      function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // マスク描画
        ctx.drawImage(maskVideo, 0, 0, canvas.width, canvas.height);

        // マスク適用
        ctx.globalCompositeOperation = "source-in";
        ctx.drawImage(bgVideo, 0, 0, canvas.width, canvas.height);

        // カメラを下地に合成
        ctx.globalCompositeOperation = "destination-over";
        ctx.drawImage(camVideo, 0, 0, canvas.width, canvas.height);

        ctx.globalCompositeOperation = "source-over";
        requestAnimationFrame(draw);
      }
      draw();
    }

    startButton.addEventListener("click", () => {
      startButton.style.display = "none";
      init();
    });
  </script>
</body>
</html>
